# NeteaseMusicAbroad

[ English follows Chinese ]

## Macç½‘æ˜“äº‘éŸ³ä¹è§£é™¤æ­Œæ›²é”åŒºé™åˆ¶

### è¯´æ˜

æ­¤å·¥å…·å¸®åŠ©Macç½‘æ˜“äº‘éŸ³ä¹çš„æµ·å¤–ç”¨æˆ·è§£é™¤æ­Œæ›²é”åŒºé™åˆ¶ï¼ˆæ‰€è°“é”åŒºï¼šå¾ˆå¤šæ­Œæ›²ä»…é™å¤§é™†åœ°åŒºæ’­æ”¾ï¼‰ã€‚<br/>
å¯¹ç”¨æˆ·æ¯”è¾ƒå‹å¥½ã€‚

ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Unblock-Youkuç­‰é€šç”¨çš„åå‘ä»£ç†è§£å†³æ–¹æ¡ˆï¼Ÿå› ä¸ºï¼š
1. Macç‰ˆç½‘æ˜“äº‘éŸ³ä¹æ²¡æœ‰å†…ç½®ä»£ç†æ¥å£ï¼Œå…¨å±€ä»£ç†ä¼šä½¿å¾—ç½‘ç»œé€šä¿¡å˜æ…¢ï¼›å³ä¾¿ä½¿ç”¨PACç­‰ï¼Œæ­Œæ›²ä¸‹è½½ç­‰è¾ƒå¤§æµé‡ä¹Ÿä¼šå˜æ…¢ï¼Œå¹¶ä¸”ä¸ç¨³å®š
2. å®‰å…¨åŸå› ï¼Œè¯·ä¸è¦è½»æ˜“ç›¸ä¿¡å•†ä¸šä»£ç†æœåŠ¡å™¨...
3. æ­¤å·¥å…·æœ€å‚»ç“œï¼Œç»¿è‰²ğŸ˜…

ä¸åŒOSä¸‹çš„ç±»ä¼¼å·¥å…·çš„è¯„è®ºåŒºç»å¸¸å‡ºç°â€œä¹°ä¸ªä¼šå‘˜ä¸å°±å¥½äº†â€ç­‰è¨€è®ºï¼Œæ³¨æ„ï¼š
1. å³ä¾¿ä¼šå‘˜ï¼Œè¯¥é”åŒºä¹Ÿä¸€æ ·é”åŒºï¼Œä¼šå‘˜åªæ˜¯å¯ä»¥å¬ç½‘æ˜“ç‰ˆæƒæ­Œæ›²
2. æƒ³äº†æƒ³è¿˜æ˜¯ç®—äº†ï¼Œä¸è¯´äº†

æ„Ÿè°¢[ä¸€ä¸ªWindowsä¸‹ç±»ä¼¼å·¥å…·](https://github.com/tiancaihb/NeteaseReverseLadder)æä¾›çš„æ€è·¯ä»¥åŠä½œè€…çš„[åšæ–‡](https://zhuanlan.zhihu.com/p/23601736)ã€‚

æ­¤å·¥å…·çš„ä½¿ç”¨ã€ä¼ æ’­ã€ä¿®æ”¹å‡æ— éœ€å¾å¾—ä½œè€…åŒæ„ï¼ŒåŒæ—¶ä½œè€…å¯¹æ­¤ä¸è´Ÿä¸€åˆ‡è´£ä»»ã€‚

### ä½¿ç”¨æ–¹æ³•

éœ€è¦æ¡ä»¶ï¼š<br/>
ä¸‹è½½è¯¥repoæ–‡ä»¶å¤¹ï¼Œä¸è¦ä¿®æ”¹ä»»ä½•æ–‡ä»¶å<br/>
å®‰è£…pythonåŒ…[Twisted](https://github.com/twisted/twisted)å’ŒPyQueryï¼ˆå‡å¯ç”¨pipå®‰è£…ï¼‰ã€‚<br/>
æœ€æ–°ç‰ˆæœ¬çš„Twistedéœ€è¦æ›´æ–°pyOpenSSLæ‰èƒ½ä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥é€‰æ‹©è£…ä¸ªæ—§ç‰ˆæœ¬ã€‚

åœ¨æ¯æ¬¡æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹ä¹‹å‰ï¼š<br/>
è¿›å…¥æ–‡ä»¶å¤¹ï¼ŒåŒå‡»NeteaseMusicHelperå³å¯ã€‚ç­‰å¾…æç¤ºä¿¡æ¯æˆåŠŸä¹‹åå¯ä»¥å…³æ‰å®ƒï¼Œç„¶åä¸€ç‰‡æ¸…å‡€ï¼Œå¼€å¿ƒå¬æ­Œï¼Œä¸ç”¨å–„åã€‚<br/>

### æµ‹è¯•ç¯å¢ƒ

macOS 10.12ï¼ŒNeteaseMusic Version 1.5.6ï¼Œpython 2.7.10ï¼Œå¹´è´¹ä¼šå‘˜ã€‚æœªæµ‹è¯•ä»»ä½•å…¶ä»–æƒ…å†µï¼Œæ¬¢è¿æµ‹è¯•æŠ¥bugè°¢è°¢ã€‚

### å®ç°ç»†èŠ‚

è§ä¸‹æ–¹Inplementation detailsã€‚è¿™é‡Œåªè¯´ä¸¤ç‚¹ï¼š<br/>
1. æ­Œå•ä¸­æ‰€æœ‰æ­Œæ›²éƒ½ä¸å†æ˜¾ç¤ºç°è‰²ï¼Œä½†ç‚¹å‡»éƒ¨åˆ†ä¸‹æ¶æ­Œæ›²ï¼ˆå¤§é™†ä¹Ÿä¸èƒ½æ’­æ”¾ï¼‰åä»ç„¶å¯èƒ½æç¤ºâ€œæ’­æ”¾å¤±è´¥â€ã€‚<br/>
2. ç›®å‰å¯¹éŸ³é¢‘æ–‡ä»¶URLè¯·æ±‚ï¼ˆä¹Ÿåªæœ‰è¿™ä¸€è¯·æ±‚ï¼‰é‡‡ç”¨çš„æ˜¯cn-proxyæä¾›çš„ä»£ç†åˆ—è¡¨ï¼Œç¼ºçœä»£ç†ä¸ºä½œè€…çš„é˜¿é‡Œäº‘åœ°å€ã€‚

_________________

### Introduction

This tool helps abroad users of NeteaseMusic for macOS unblock songs that are allowed to play in mainland China only.

Why general solutions like Unblock-Youku are not recommended? Because:
1. NeteaseMusic for macOS does not provide a proxy interface, so global proxy will slow down the network traffic; Even if PAC is used, when it comes to audio stream downloading, the latency and unstableness become annoying.
2. For safety reasons, better not to trust commercial proxy servers.
3. This tool is most lightweight and easy to use.

Thanks to a similar tool [NeteaseReverseLadder](https://github.com/tiancaihb/NeteaseReverseLadder) on Windows and the author's [blog](https://zhuanlan.zhihu.com/p/23601736).

Copyright: The author waives all rights, please feel free to use, share and modify this tool.

### Usage

Prerequisites: <br/>
1. Download this folder and do not change file names.
2. Install Python package [Twisted](https://github.com/twisted/twisted) and PyQuery. You may also need to update pyOpenSSL or use a older version of Twisted.

Everytime before you launch NeteaseMusic:<br/>
Just enter the folder and double-click "NeteaseMusicHelper". See the success info and then be free to close it, enjoy your music.

### Test Environment

macOS 10.12ï¼ŒNeteaseMusic Version 1.5.6ï¼Œpython 2.7.10, yearly-paid membership.<br/>
Other cases are not tested and your report is welcomed.

### Implementation Details

Part 1. Force NeteaseMusic to communicate with Netease servers through local proxy.

Methods that I tried:
1. Use `pfctl` (package forwarding), like `iptables` on Linux. Not working normally & too less helpful documentations, given up.
2. Use [proxychains](https://github.com/rofl0r/proxychains-ng), a preloader which hooks calls to sockets in dynamically linked programs and redirects it through proxies. It is basically a hack and hacks do not always work. Acting weired on NeteaseMusic for macOS, issue reported at [#181](https://github.com/rofl0r/proxychains-ng/issues/181). Remaining unsolved.
3. Use `networksetup`, macOS network PAC. It works easily.

Part 2. Intercept, modify and redirect requests.

See `NeteaseMusicProxy.py` (deployed as local proxy) and `AudioRequestProxy.py` (deployed as domestic proxy).

Mainland proxy server is dynamically selected from http://cn-proxy.com/. Because those proxies can be unstable (may be refused by NeteaseMusic server), so an auto proxy selector will replace current proxy with new one or default one after a certain amount of request failures.
